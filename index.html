<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DualForge‚ÄëTagger</title>
  <!-- Tailwind via CDN for styling.  See https://cdn.tailwindcss.com for docs. -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- JSZip for handling ZIP files client‚Äëside. -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col items-center p-4 sm:p-6 md:p-8">
  <header class="text-center mb-8">
    <h1 class="text-4xl sm:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-500">
      DualForge‚ÄëTagger
    </h1>
    <p class="text-gray-400 mt-2">Generate AI‚Äëpowered captions and tags for your images.</p>
  </header>
  <main class="w-full max-w-4xl bg-gray-800/50 rounded-2xl shadow-2xl backdrop-blur-sm border border-gray-700 p-6 md:p-8">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
      <!-- Control panel -->
      <div id="controls" class="flex flex-col space-y-6">
        <!-- Upload mode -->
        <div>
          <h3 class="font-semibold mb-3 text-lg text-cyan-300">1. Select Upload Mode</h3>
          <div class="flex space-x-2 bg-gray-900 p-1 rounded-lg">
            <button id="mode-single" class="w-full py-2 px-4 rounded-md text-sm font-medium transition-colors bg-cyan-500 text-white shadow">
              Single Image
            </button>
            <button id="mode-batch" class="w-full py-2 px-4 rounded-md text-sm font-medium transition-colors hover:bg-gray-700">
              Batch (ZIP)
            </button>
          </div>
        </div>
        <!-- Tag style -->
        <div>
          <h3 class="font-semibold mb-3 text-lg text-cyan-300">2. Choose Tag Style</h3>
          <div class="space-y-3">
            <div id="style-flux" class="p-4 rounded-lg cursor-pointer transition-all border-2 border-purple-500 bg-purple-500/10">
              <h4 class="font-bold">‚ú® Flux Style</h4>
              <p class="text-sm text-gray-400 mt-1">Creative, human‚Äëlike captions.</p>
            </div>
            <div id="style-illustrious" class="p-4 rounded-lg cursor-pointer transition-all border-2 border-gray-700 hover:border-purple-400 bg-gray-900">
              <h4 class="font-bold">üéØ Illustrious Style</h4>
              <p class="text-sm text-gray-400 mt-1">Comma‚Äëseparated LoRA training tags.</p>
            </div>
          </div>
        </div>
        <!-- File input -->
        <div>
          <h3 class="font-semibold mb-3 text-lg text-cyan-300">3. Upload Your File</h3>
          <div id="file-drop" class="relative border-2 border-dashed border-gray-600 rounded-lg p-6 text-center hover:border-cyan-400 transition-colors">
            <div class="mx-auto h-12 w-12 flex items-center justify-center text-gray-500">
              <!-- Upload icon (inline SVG) -->
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 6-6m-6 6V4.5" />
              </svg>
            </div>
            <p class="mt-2 text-sm text-gray-400">
              <span class="font-semibold text-cyan-400">Click to upload</span> or drag and drop
            </p>
            <p id="file-hint" class="text-xs text-gray-500 mt-1">PNG, JPG, WEBP</p>
            <input id="file-input" type="file" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
          </div>
          <p id="selected-file" class="text-sm text-gray-400 mt-2 truncate hidden"></p>
        </div>
        <button id="generate-btn" class="w-full bg-gradient-to-r from-cyan-500 to-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:from-cyan-600 hover:to-purple-700 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
          Generate Tags
        </button>
      </div>
      <!-- Result panel -->
      <div id="result-panel" class="bg-gray-900 p-6 rounded-lg flex flex-col">
        <h3 class="font-semibold mb-4 text-lg text-purple-300">Result</h3>
        <div id="error-message" class="bg-red-500/20 border border-red-500 text-red-300 p-3 rounded-md mb-4 text-sm hidden"></div>
        <div id="loading-section" class="flex-grow flex-col items-center justify-center text-center hidden">
          <div class="flex justify-center mb-4">
            <svg class="animate-spin h-10 w-10 text-cyan-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
            </svg>
          </div>
          <p class="text-lg font-semibold text-gray-300">Working on it...</p>
          <p id="loading-text" class="text-sm text-gray-500 mt-1"></p>
        </div>
        <!-- Preview or output area -->
        <div id="output-area" class="flex-grow flex flex-col"></div>
      </div>
    </div>
  </main>
  <!-- Developer Instructions Section -->
  <section class="mt-12 bg-gray-800 p-6 rounded-lg border border-gray-700 max-w-4xl w-full">
    <h3 class="text-lg font-semibold text-cyan-300 mb-3">For Web Developers (Using Gemini Nano via APIs)</h3>
    <p class="text-sm text-gray-400 mb-2">
      Gemini Nano is exposed through Chrome's built-in AI APIs (Prompt API, Summarizer API, Writer API, etc.) that enable on-device AI capabilities for web applications and Chrome extensions.
    </p>
    <ul class="list-disc list-inside text-gray-400 text-sm space-y-1">
      <li><span class="font-semibold">Prerequisites:</span> Use a Chrome Dev or Canary build (version&nbsp;127 or higher). Ensure your device meets the necessary hardware requirements (sufficient RAM, VRAM and storage).</li>
      <li><span class="font-semibold">Enable Flags:</span> Navigate to <code>chrome://flags</code> and enable the following experimental flags:
        <ul class="list-disc list-inside pl-4 space-y-1">
          <li><code>#prompt-api-for-gemini-nano</code> ‚Üí set to ‚ÄúEnabled‚Äù</li>
          <li><code>#optimization-guide-on-device-model</code> ‚Üí set to ‚ÄúEnabled BypassPrefRequirement‚Äù (or a similar option)</li>
        </ul>
      </li>
      <li><span class="font-semibold">Model Download:</span> Go to <code>chrome://components</code>, locate <em>Optimization Guide On Device Model</em> and click <em>Check for Update</em>. The model downloads in the background when your device is eligible.</li>
      <li><span class="font-semibold">Verification:</span> Open the Developer Console (F12 or Option+‚åò+J on Mac) and run <code>await ai.canCreateTextSession()</code>. A return value of <code>'readily'</code> confirms the model is ready.</li>
      <li><span class="font-semibold">Use the APIs:</span> Interact with Gemini Nano in your JavaScript via the exposed APIs (e.g. <code>ai.createTextSession()</code> for the Prompt API). These APIs enable on-device summarization, translation, proofreading and more ‚Äî delivering speed and privacy by processing locally.</li>
    </ul>
  </section>
  <!-- Inline script containing the app logic.  We avoid external modules to ensure compatibility when opening via file://. -->
  <script>
    // Application state
    let uploadMode = 'single';
    let tagStyle = 'flux';
    let selectedFile = null;

    // DOM references
    const modeSingleBtn = document.getElementById('mode-single');
    const modeBatchBtn = document.getElementById('mode-batch');
    const styleFluxDiv = document.getElementById('style-flux');
    const styleIllDiv = document.getElementById('style-illustrious');
    const fileInput = document.getElementById('file-input');
    const fileDrop = document.getElementById('file-drop');
    const fileHint = document.getElementById('file-hint');
    const selectedFileText = document.getElementById('selected-file');
    const generateBtn = document.getElementById('generate-btn');
    const errorMessage = document.getElementById('error-message');
    const loadingSection = document.getElementById('loading-section');
    const loadingText = document.getElementById('loading-text');
    const outputArea = document.getElementById('output-area');

    function resetUI() {
      errorMessage.classList.add('hidden');
      errorMessage.textContent = '';
      loadingSection.classList.add('hidden');
      loadingText.textContent = '';
      outputArea.innerHTML = '';
      selectedFileText.classList.add('hidden');
      generateBtn.disabled = true;
      generateBtn.textContent = 'Generate Tags';
    }

    function selectUploadMode(mode) {
      uploadMode = mode;
      resetUI();
      selectedFile = null;
      fileInput.value = '';
      if (mode === 'single') {
        modeSingleBtn.classList.add('bg-cyan-500', 'text-white', 'shadow');
        modeSingleBtn.classList.remove('hover:bg-gray-700');
        modeBatchBtn.classList.remove('bg-cyan-500', 'text-white', 'shadow');
        modeBatchBtn.classList.add('hover:bg-gray-700');
        fileHint.textContent = 'PNG, JPG, WEBP';
        fileInput.accept = 'image/*';
      } else {
        modeBatchBtn.classList.add('bg-cyan-500', 'text-white', 'shadow');
        modeBatchBtn.classList.remove('hover:bg-gray-700');
        modeSingleBtn.classList.remove('bg-cyan-500', 'text-white', 'shadow');
        modeSingleBtn.classList.add('hover:bg-gray-700');
        fileHint.textContent = 'ZIP file with images';
        fileInput.accept = '.zip,application/zip';
      }
    }

    function selectTagStyle(style) {
      tagStyle = style;
      if (style === 'flux') {
        styleFluxDiv.classList.add('border-purple-500', 'bg-purple-500/10');
        styleFluxDiv.classList.remove('border-gray-700', 'hover:border-purple-400', 'bg-gray-900');
        styleIllDiv.classList.remove('border-purple-500', 'bg-purple-500/10');
        styleIllDiv.classList.add('border-gray-700', 'hover:border-purple-400', 'bg-gray-900');
      } else {
        styleIllDiv.classList.add('border-purple-500', 'bg-purple-500/10');
        styleIllDiv.classList.remove('border-gray-700', 'hover:border-purple-400', 'bg-gray-900');
        styleFluxDiv.classList.remove('border-purple-500', 'bg-purple-500/10');
        styleFluxDiv.classList.add('border-gray-700', 'hover:border-purple-400', 'bg-gray-900');
      }
    }

    modeSingleBtn.addEventListener('click', () => selectUploadMode('single'));
    modeBatchBtn.addEventListener('click', () => selectUploadMode('batch'));
    styleFluxDiv.addEventListener('click', () => selectTagStyle('flux'));
    styleIllDiv.addEventListener('click', () => selectTagStyle('illustrious'));

    fileInput.addEventListener('change', (e) => {
      resetUI();
      const files = e.target.files;
      if (files && files[0]) {
        selectedFile = files[0];
        selectedFileText.textContent = `Selected: ${selectedFile.name}`;
        selectedFileText.classList.remove('hidden');
        generateBtn.disabled = false;
      }
    });

    fileDrop.addEventListener('click', () => {
      fileInput.click();
    });
    fileDrop.addEventListener('dragover', (e) => {
      e.preventDefault();
      fileDrop.classList.add('border-cyan-400');
    });
    fileDrop.addEventListener('dragleave', () => {
      fileDrop.classList.remove('border-cyan-400');
    });
    fileDrop.addEventListener('drop', (e) => {
      e.preventDefault();
      fileDrop.classList.remove('border-cyan-400');
      const files = e.dataTransfer.files;
      if (files && files[0]) {
        fileInput.files = files;
        const changeEvent = new Event('change');
        fileInput.dispatchEvent(changeEvent);
      }
    });

    async function callPromptApi(blob, style) {
      const instruction = style === 'flux'
        ? 'You are an AI assistant for captioning anime images. Return a short, natural language description.'
        : 'You are an AI assistant for tagging anime images. Return a comma-separated list of LoRA-style tags (e.g. 1girl, brown hair, smile).';
      if (!chrome || !chrome.promptApi || !chrome.promptApi.request) {
        throw new Error('The Chrome Prompt API is not available in this browser.');
      }
      const resp = await chrome.promptApi.request({ input: { image: blob }, prompt: instruction });
      return (resp.output && resp.output.text) || '';
    }

    async function processSingleImage() {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async () => {
          try {
            const arrayBuffer = reader.result;
            const blob = new Blob([arrayBuffer], { type: selectedFile.type });
            const tags = await callPromptApi(blob, tagStyle);
            resolve(tags);
          } catch (err) {
            reject(err);
          }
        };
        reader.onerror = () => reject(reader.error);
        reader.readAsArrayBuffer(selectedFile);
      });
    }

    async function processBatchZip() {
      const JSZip = window.JSZip;
      if (!JSZip) {
        throw new Error('JSZip library is not loaded.');
      }
      const zip = new JSZip();
      const loadedZip = await zip.loadAsync(selectedFile);
      const imageFiles = Object.values(loadedZip.files).filter(f => !f.dir && /\.(png|jpe?g|webp)$/i.test(f.name));
      if (imageFiles.length === 0) {
        throw new Error('No valid images found in the ZIP file.');
      }
      const outputZip = new JSZip();
      let processed = 0;
      for (const file of imageFiles) {
        processed++;
        loadingText.textContent = `Processing image ${processed} of ${imageFiles.length}...`;
        const content = await file.async('blob');
        const tags = await callPromptApi(content, tagStyle);
        const base = file.name.substring(0, file.name.lastIndexOf('.'));
        outputZip.file(`${base}.txt`, tags);
      }
      return await outputZip.generateAsync({ type: 'blob' });
    }

    generateBtn.addEventListener('click', async () => {
      if (!selectedFile) return;
      errorMessage.classList.add('hidden');
      outputArea.innerHTML = '';
      loadingSection.classList.remove('hidden');
      generateBtn.disabled = true;
      generateBtn.textContent = 'Processing...';
      try {
        if (uploadMode === 'single') {
          const tags = await processSingleImage();
          loadingSection.classList.add('hidden');
          const imgUrl = URL.createObjectURL(selectedFile);
          const preview = document.createElement('img');
          preview.src = imgUrl;
          preview.className = 'mb-4 rounded-lg overflow-hidden border border-gray-700 w-full h-auto max-h-60 object-contain';
          const tagDiv = document.createElement('div');
          tagDiv.className = 'relative bg-gray-800 p-4 rounded-md flex-grow';
          const pre = document.createElement('pre');
          pre.textContent = tags;
          pre.className = 'text-sm text-gray-300 whitespace-pre-wrap font-sans';
          const copyBtn = document.createElement('button');
          copyBtn.className = 'absolute top-2 right-2 p-2 rounded-md bg-gray-700 hover:bg-gray-600 transition-colors';
          copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-5 w-5 text-gray-400"><path stroke-linecap="round" stroke-linejoin="round" d="M7.5 9V6.75A2.25 2.25 0 019.75 4.5h6.5A2.25 2.25 0 0118.5 6.75V15a2.25 2.25 0 01-2.25 2.25H13.5" /><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 14.25V17.5A2.25 2.25 0 0114.25 19.75H7.75A2.25 2.25 0 015.5 17.5V9a2.25 2.25 0 012.25-2.25h3.75" /></svg>';
          copyBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(tags);
            copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="h-5 w-5 text-green-400"><path fill-rule="evenodd" d="M2.25 12a9.75 9.75 0 1119.5 0 9.75 9.75 0 01-19.5 0zm6.78 3.53l-2.53-2.53a.75.75 0 10-1.06 1.06l3.06 3.06a.75.75 0 001.06 0l7.22-7.22a.75.75 0 10-1.06-1.06L9.03 15.53z" clip-rule="evenodd" /></svg>';
            setTimeout(() => {
              copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-5 w-5 text-gray-400"><path stroke-linecap="round" stroke-linejoin="round" d="M7.5 9V6.75A2.25 2.25 0 019.75 4.5h6.5A2.25 2.25 0 0118.5 6.75V15a2.25 2.25 0 01-2.25 2.25H13.5" /><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 14.25V17.5A2.25 2.25 0 0114.25 19.75H7.75A2.25 2.25 0 015.5 17.5V9a2.25 2.25 0 012.25-2.25h3.75" /></svg>';
            }, 2000);
          });
          tagDiv.appendChild(pre);
          tagDiv.appendChild(copyBtn);
          outputArea.appendChild(preview);
          outputArea.appendChild(tagDiv);
        } else {
          loadingText.textContent = 'Unpacking your ZIP file...';
          const zipped = await processBatchZip();
          loadingSection.classList.add('hidden');
          const successDiv = document.createElement('div');
          successDiv.className = 'flex-grow flex flex-col items-center justify-center text-center p-4 bg-green-900/50 border border-green-700 rounded-lg';
          successDiv.innerHTML = '<h4 class="text-lg font-bold text-green-300">Success!</h4><p class="text-sm text-gray-400 mt-1 mb-4">Your ZIP file with tags is ready.</p>';
          const downloadLink = document.createElement('a');
          const baseName = selectedFile.name.replace(/\.zip$/i, '');
          downloadLink.href = URL.createObjectURL(zipped);
          downloadLink.download = `${baseName}-tags.zip`;
          downloadLink.className = 'bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition-colors flex items-center space-x-2';
          downloadLink.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-5 w-5"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 6-6m-6 6V4.5" /></svg><span>Download ZIP</span>';
          successDiv.appendChild(downloadLink);
          outputArea.appendChild(successDiv);
        }
      } catch (err) {
        loadingSection.classList.add('hidden');
        errorMessage.textContent = err.message || String(err);
        errorMessage.classList.remove('hidden');
      } finally {
        generateBtn.disabled = false;
        generateBtn.textContent = 'Generate Tags';
      }
    });

    // Initialize defaults
    selectUploadMode('single');
    selectTagStyle('flux');
  </script>
</body>
</html>